<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Josh Moak and Owen Fiore">
<meta name="dcterms.date" content="2024-04-22">

<title>STAT 5125 Final Project</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Report_files/libs/clipboard/clipboard.min.js"></script>
<script src="Report_files/libs/quarto-html/quarto.js"></script>
<script src="Report_files/libs/quarto-html/popper.min.js"></script>
<script src="Report_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Report_files/libs/quarto-html/anchor.min.js"></script>
<link href="Report_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Report_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Report_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Report_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Report_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">STAT 5125 Final Project</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Josh Moak and Owen Fiore </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">2024-04-22</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p>In this project we seek to explore patterns and identify trends in a dataset consisting of 10,000 car insurance claims available at <a href="https://www.kaggle.com/datasets/sagnik1511/car-insurance-data">the link here</a>. You can also find the data available in the repo at <code>Car_Insurance_Claim.csv</code>.</p>
<section id="data-import" class="level1">
<h1>Data Import</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"Car_Insurance_Claim.csv"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      ID   AGE GENDER     RACE DRIVING_EXPERIENCE   EDUCATION        INCOME
1 569520   65+ female majority               0-9y high school   upper class
2 750365 16-25   male majority               0-9y        none       poverty
3 199901 16-25 female majority               0-9y high school working class
4 478866 16-25   male majority               0-9y  university working class
5 731664 26-39   male majority             10-19y        none working class
6 877557 40-64 female majority             20-29y high school   upper class
  CREDIT_SCORE VEHICLE_OWNERSHIP VEHICLE_YEAR MARRIED CHILDREN POSTAL_CODE
1    0.6290273                 1   after 2015       0        1       10238
2    0.3577571                 0  before 2015       0        0       10238
3    0.4931458                 1  before 2015       0        0       10238
4    0.2060129                 1  before 2015       0        1       32765
5    0.3883659                 1  before 2015       0        0       32765
6    0.6191274                 1   after 2015       0        1       10238
  ANNUAL_MILEAGE VEHICLE_TYPE SPEEDING_VIOLATIONS DUIS PAST_ACCIDENTS OUTCOME
1          12000        sedan                   0    0              0       0
2          16000        sedan                   0    0              0       1
3          11000        sedan                   0    0              0       0
4          11000        sedan                   0    0              0       0
5          12000        sedan                   2    0              1       1
6          13000        sedan                   3    0              3       0</code></pre>
</div>
</div>
<p>We read in the data and we see that some data is character, some is numeric, and some is stored in a dbl.</p>
<pre><code>Regex: AGE, driving experience, vehicle year</code></pre>
</section>
<section id="data-cleaning" class="level1">
<h1>Data Cleaning</h1>
<section id="impute-missing-values" class="level3">
<h3 class="anchored" data-anchor-id="impute-missing-values">Impute missing values</h3>
<p>The first thing we are going to do is deal with missing data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'ggplot2' was built under R version 4.3.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'tidyr' was built under R version 4.3.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.4
✔ forcats   1.0.0     ✔ stringr   1.5.0
✔ ggplot2   3.5.0     ✔ tibble    3.2.1
✔ lubridate 1.9.2     ✔ tidyr     1.3.1
✔ purrr     1.0.2     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'tidymodels' was built under R version 4.3.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching packages ────────────────────────────────────── tidymodels 1.2.0 ──
✔ broom        1.0.5      ✔ rsample      1.2.1 
✔ dials        1.2.1      ✔ tune         1.2.0 
✔ infer        1.0.7      ✔ workflows    1.1.4 
✔ modeldata    1.3.0      ✔ workflowsets 1.1.0 
✔ parsnip      1.2.1      ✔ yardstick    1.3.1 
✔ recipes      1.0.10     </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'dials' was built under R version 4.3.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'infer' was built under R version 4.3.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'parsnip' was built under R version 4.3.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'recipes' was built under R version 4.3.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'rsample' was built under R version 4.3.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'tune' was built under R version 4.3.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'workflows' was built under R version 4.3.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'workflowsets' was built under R version 4.3.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'yardstick' was built under R version 4.3.2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──
✖ scales::discard() masks purrr::discard()
✖ dplyr::filter()   masks stats::filter()
✖ recipes::fixed()  masks stringr::fixed()
✖ dplyr::lag()      masks stats::lag()
✖ yardstick::spec() masks readr::spec()
✖ recipes::step()   masks stats::step()
• Search for functions across packages at https://www.tidymodels.org/find/</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(visdat)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span> <span class="fu">vis_dat</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Report_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Here we see that we have a lot of data of type character which will likely need to be changed. However what we see is we only have 2 columns with missing data which is good.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span> <span class="fu">vis_miss</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Report_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(naniar)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span> <span class="fu">miss_var_summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 19 × 3
   variable            n_miss pct_miss
   &lt;chr&gt;                &lt;int&gt;    &lt;dbl&gt;
 1 CREDIT_SCORE           982     9.82
 2 ANNUAL_MILEAGE         957     9.57
 3 ID                       0     0   
 4 AGE                      0     0   
 5 GENDER                   0     0   
 6 RACE                     0     0   
 7 DRIVING_EXPERIENCE       0     0   
 8 EDUCATION                0     0   
 9 INCOME                   0     0   
10 VEHICLE_OWNERSHIP        0     0   
11 VEHICLE_YEAR             0     0   
12 MARRIED                  0     0   
13 CHILDREN                 0     0   
14 POSTAL_CODE              0     0   
15 VEHICLE_TYPE             0     0   
16 SPEEDING_VIOLATIONS      0     0   
17 DUIS                     0     0   
18 PAST_ACCIDENTS           0     0   
19 OUTCOME                  0     0   </code></pre>
</div>
</div>
<p>Lets impute missing values based on the median of the column</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(naniar)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nabular</span>(<span class="at">only_miss =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CREDIT_SCORE =</span> naniar<span class="sc">::</span><span class="fu">impute_median</span>(CREDIT_SCORE),</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">ANNUAL_MILEAGE =</span> naniar<span class="sc">::</span><span class="fu">impute_median</span>(ANNUAL_MILEAGE)) <span class="sc">|&gt;</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>CREDIT_SCORE_NA, <span class="sc">-</span>ANNUAL_MILEAGE_NA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span> <span class="fu">n_miss</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0</code></pre>
</div>
</div>
</section>
<section id="regular-expression" class="level3">
<h3 class="anchored" data-anchor-id="regular-expression">Regular Expression</h3>
<p>We see there are no longer any missing values. We are now ready to use regular expression to alter and extract the meaningful string data. We have 3 columns of interest for this part: <code>AGE</code>, <code>Driving_Experince</code>, and <code>VEHICLE_YEAR</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span> <span class="fu">select</span>(AGE) <span class="sc">|&gt;</span> <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 1
   AGE  
   &lt;chr&gt;
 1 65+  
 2 16-25
 3 16-25
 4 16-25
 5 26-39
 6 40-64
 7 65+  
 8 26-39
 9 40-64
10 40-64</code></pre>
</div>
</div>
<p>Using this and our knowledge of who drives cars, we know that all the information we need is going to be contained in the first two integers as somebody who is less than 10 years old cannot drive and anybody who would be 100 is grouped into 65+. Thus we need a regular expression to keep only the first 2 numbers.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">AGE =</span> <span class="fu">as.integer</span>(stringr<span class="sc">::</span><span class="fu">str_extract</span>(AGE, <span class="st">"^</span><span class="sc">\\</span><span class="st">d{1,2}"</span>)))</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span> <span class="fu">select</span>(AGE) <span class="sc">|&gt;</span> <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 1
     AGE
   &lt;int&gt;
 1    65
 2    16
 3    16
 4    16
 5    26
 6    40
 7    65
 8    26
 9    40
10    40</code></pre>
</div>
</div>
<p>This looks much better and is something that can be converted to a factor variable later on.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span> <span class="fu">select</span>(DRIVING_EXPERIENCE) <span class="sc">|&gt;</span> <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 1
   DRIVING_EXPERIENCE
   &lt;chr&gt;             
 1 0-9y              
 2 0-9y              
 3 0-9y              
 4 0-9y              
 5 10-19y            
 6 20-29y            
 7 30y+              
 8 0-9y              
 9 20-29y            
10 0-9y              </code></pre>
</div>
</div>
<p>Lets use the <code>parse_number</code> function from the <code>readr</code> package to extract the first number available.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DRIVING_EXPERIENCE =</span> <span class="fu">parse_number</span>(DRIVING_EXPERIENCE))</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span> <span class="fu">select</span>(DRIVING_EXPERIENCE) <span class="sc">|&gt;</span> <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 1
   DRIVING_EXPERIENCE
                &lt;dbl&gt;
 1                  0
 2                  0
 3                  0
 4                  0
 5                 10
 6                 20
 7                 30
 8                  0
 9                 20
10                  0</code></pre>
</div>
</div>
<p>This looks much better.</p>
<p>Lastly we look at <code>VEHICLE_YEAR</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span> <span class="fu">select</span>(VEHICLE_YEAR) <span class="sc">|&gt;</span> <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 1
   VEHICLE_YEAR
   &lt;chr&gt;       
 1 after 2015  
 2 before 2015 
 3 before 2015 
 4 before 2015 
 5 before 2015 
 6 after 2015  
 7 after 2015  
 8 after 2015  
 9 before 2015 
10 before 2015 </code></pre>
</div>
</div>
<p>There seem to be only two types of data in this column: <code>before 2015</code> and <code>after 2015</code>. We are going to make this easier for us later on and convert this data to numeric.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">VEHICLE_YEAR =</span> <span class="fu">ifelse</span>(<span class="fu">str_detect</span>(VEHICLE_YEAR, <span class="st">"^before"</span>),<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span> <span class="fu">select</span>(VEHICLE_YEAR) <span class="sc">|&gt;</span> <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 1
   VEHICLE_YEAR
          &lt;dbl&gt;
 1            1
 2            0
 3            0
 4            0
 5            0
 6            1
 7            1
 8            1
 9            0
10            0</code></pre>
</div>
</div>
<p>We have now replaced this data with 0s and 1s.</p>
<p>We have now used regular expression and string functions to clean our data. Now lets convert appropriate columns to factor variables. The following columns need to be changed: <code>AGE</code>, <code>GENDER</code>, <code>RACE</code>, <code>DRIVING EXPERIENCE</code>, <code>EDUCATION</code>, <code>INCOME</code>, <code>VEHICLE_OWNERSHIP</code>, <code>VEHICLE YEAR</code>, <code>MARRIED</code>, <code>CHILDREN</code>, <code>VEHICHLE_TYPE</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">AGE =</span> <span class="fu">ifelse</span>(AGE <span class="sc">==</span> <span class="dv">16</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(AGE <span class="sc">==</span> <span class="dv">26</span>, <span class="dv">1</span>, <span class="fu">ifelse</span>(AGE <span class="sc">==</span> <span class="dv">40</span>, <span class="dv">2</span>, <span class="dv">3</span>)))) <span class="sc">|&gt;</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">AGE =</span> <span class="fu">factor</span>(AGE))</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">GENDER =</span> <span class="fu">ifelse</span>(GENDER <span class="sc">==</span> <span class="st">"female"</span>, <span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">GENDER =</span> <span class="fu">factor</span>(GENDER))</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RACE =</span> <span class="fu">ifelse</span>(RACE <span class="sc">==</span> <span class="st">"minority"</span>, <span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">RACE =</span> <span class="fu">factor</span>(RACE))</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DRIVING_EXPERIENCE =</span> <span class="fu">as.integer</span>(<span class="fu">str_extract</span>(<span class="fu">as.character</span>(DRIVING_EXPERIENCE), <span class="st">"</span><span class="sc">\\</span><span class="st">d"</span>))) <span class="sc">|&gt;</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DRIVING_EXPERIENCE =</span> <span class="fu">factor</span>(DRIVING_EXPERIENCE))</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EDUCATION =</span> <span class="fu">ifelse</span>(EDUCATION <span class="sc">==</span> <span class="st">"none"</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(EDUCATION <span class="sc">==</span> <span class="st">"high school"</span>, <span class="dv">1</span>, <span class="dv">2</span>))) <span class="sc">|&gt;</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">EDUCATION =</span> <span class="fu">factor</span>(EDUCATION))</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>income_fct <span class="ot">&lt;-</span> <span class="cf">function</span>(dataframe, col){</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>  dataframe <span class="ot">&lt;-</span> dataframe <span class="sc">|&gt;</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">col =</span> )</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">INCOME =</span> <span class="fu">ifelse</span>(INCOME <span class="sc">==</span> <span class="st">"poverty"</span>, <span class="dv">0</span>, <span class="fu">ifelse</span>(INCOME <span class="sc">==</span> <span class="st">"working class"</span>, <span class="dv">1</span>, <span class="fu">ifelse</span>(INCOME <span class="sc">==</span> <span class="st">"middle class"</span>, <span class="dv">2</span>, <span class="dv">3</span>)))) <span class="sc">|&gt;</span></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">INCOME =</span> <span class="fu">factor</span>(INCOME))</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">VEHICLE_OWNERSHIP =</span> <span class="fu">factor</span>(VEHICLE_OWNERSHIP))</span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">VEHICLE_YEAR =</span> <span class="fu">factor</span>(VEHICLE_YEAR))</span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">MARRIED =</span> <span class="fu">factor</span>(MARRIED))</span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">CHILDREN =</span> <span class="fu">factor</span>(CHILDREN))</span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ANNUAL_MILEAGE =</span> <span class="fu">factor</span>(ANNUAL_MILEAGE))</span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">VEHICLE_TYPE =</span> <span class="fu">ifelse</span>(VEHICLE_TYPE <span class="sc">==</span> <span class="st">"sedan"</span>, <span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">|&gt;</span></span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">VEHICLE_TYPE =</span> <span class="fu">factor</span>(VEHICLE_TYPE))</span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SPEEDING_VIOLATIONS =</span> <span class="fu">factor</span>(SPEEDING_VIOLATIONS))</span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">DUIS =</span> <span class="fu">factor</span>(DUIS))</span>
<span id="cb40-55"><a href="#cb40-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-56"><a href="#cb40-56" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb40-57"><a href="#cb40-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">PAST_ACCIDENTS =</span> <span class="fu">factor</span>(PAST_ACCIDENTS))</span>
<span id="cb40-58"><a href="#cb40-58" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 10,000
Columns: 19
$ ID                  &lt;int&gt; 569520, 750365, 199901, 478866, 731664, 877557, 93…
$ AGE                 &lt;fct&gt; 3, 0, 0, 0, 1, 2, 3, 1, 2, 2, 3, 3, 2, 0, 1, 1, 3,…
$ GENDER              &lt;fct&gt; 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1,…
$ RACE                &lt;fct&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…
$ DRIVING_EXPERIENCE  &lt;fct&gt; 0, 0, 0, 0, 1, 2, 3, 0, 2, 0, 3, 3, 2, 0, 1, 0, 3,…
$ EDUCATION           &lt;fct&gt; 1, 0, 1, 2, 0, 1, 1, 2, 2, 1, 1, 1, 1, 2, 1, 1, 2,…
$ INCOME              &lt;fct&gt; 3, 0, 1, 1, 1, 3, 3, 1, 1, 3, 3, 3, 3, 3, 2, 3, 3,…
$ CREDIT_SCORE        &lt;dbl&gt; 0.6290273, 0.3577571, 0.4931458, 0.2060129, 0.3883…
$ VEHICLE_OWNERSHIP   &lt;fct&gt; 1, 0, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1,…
$ VEHICLE_YEAR        &lt;fct&gt; 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0, 1, 0,…
$ MARRIED             &lt;fct&gt; 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 1, 1, 1,…
$ CHILDREN            &lt;fct&gt; 1, 0, 0, 1, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 1,…
$ POSTAL_CODE         &lt;int&gt; 10238, 10238, 10238, 32765, 32765, 10238, 10238, 1…
$ ANNUAL_MILEAGE      &lt;fct&gt; 12000, 16000, 11000, 11000, 12000, 13000, 13000, 1…
$ VEHICLE_TYPE        &lt;fct&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ SPEEDING_VIOLATIONS &lt;fct&gt; 0, 0, 0, 0, 2, 3, 7, 0, 0, 0, 6, 4, 4, 0, 0, 0, 10…
$ DUIS                &lt;fct&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 1, 0, 2, 0, 2,…
$ PAST_ACCIDENTS      &lt;fct&gt; 0, 0, 0, 0, 1, 3, 3, 0, 0, 0, 7, 0, 2, 0, 1, 0, 1,…
$ OUTCOME             &lt;dbl&gt; 0, 1, 0, 0, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0,…</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(df, <span class="st">"factor_data.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="data-exploration" class="level1">
<h1>Data Exploration</h1>
<p>Now that we have a clean dataset, we are ready to visualize our data to explore any trends and possibly verify any assumptions that we need for later on. First however we are going to run a PCA to look at what variables are contributing the most to variance in the data.</p>
<section id="pca" class="level2">
<h2 class="anchored" data-anchor-id="pca">PCA</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"factor_data.csv"</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>pca <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">!</span><span class="fu">c</span>(ID, OUTCOME)) <span class="sc">|&gt;</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prcomp</span>(<span class="at">scale =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lets look at the principal component directions</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>pca<span class="sc">$</span>rotation</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                            PC1          PC2         PC3           PC4
AGE                 -0.38759191  0.034524481 -0.03167154 -0.1865944975
GENDER              -0.04508527  0.254889591 -0.21186286  0.5591387729
RACE                -0.02674345 -0.097180982 -0.12553475  0.3861884480
DRIVING_EXPERIENCE  -0.36148368  0.277381715 -0.16793716 -0.1854763109
EDUCATION           -0.22508086 -0.347580119 -0.15810011  0.3084071776
INCOME              -0.38273034 -0.315268874 -0.09624052  0.0255378665
CREDIT_SCORE        -0.29733992 -0.356362547 -0.09091875 -0.0800974606
VEHICLE_OWNERSHIP   -0.19878893 -0.261372518 -0.12466388  0.0172310178
VEHICLE_YEAR        -0.16718213 -0.253161936 -0.12464582  0.0329971628
MARRIED             -0.25429150 -0.057463420  0.37760736 -0.0130785645
CHILDREN            -0.23012675  0.039781382  0.43669146 -0.1119344525
POSTAL_CODE         -0.01878024  0.009836077  0.28177746  0.5464679922
ANNUAL_MILEAGE       0.21391050 -0.074443603 -0.59634089 -0.1313300682
VEHICLE_TYPE         0.00585871  0.009121846  0.04231691 -0.0005751707
SPEEDING_VIOLATIONS -0.29698453  0.373091964 -0.04608831  0.1473699165
DUIS                -0.19328394  0.303614313 -0.15954958  0.0712392827
PAST_ACCIDENTS      -0.27204160  0.354769921 -0.19715160 -0.1003313048
                            PC5         PC6           PC7         PC8
AGE                 -0.09367205 -0.01525475 -0.0478369827  0.03072025
GENDER               0.44237443  0.07536495  0.4145287500 -0.03829920
RACE                 0.19484893  0.06350135 -0.8475951860  0.15162813
DRIVING_EXPERIENCE  -0.17566827 -0.03522277 -0.1239021826  0.04657221
EDUCATION            0.11728693 -0.01284489  0.0419889127 -0.13510946
INCOME              -0.01280852 -0.01950821  0.0673074701 -0.05600119
CREDIT_SCORE        -0.10441475 -0.03027497  0.0142552647 -0.07714042
VEHICLE_OWNERSHIP    0.01274032 -0.08890909  0.0929947761 -0.47263695
VEHICLE_YEAR        -0.04737221  0.10456070  0.2350098890  0.82055327
MARRIED              0.23816735  0.03306134 -0.0280021853 -0.06507925
CHILDREN             0.16468054  0.09157415 -0.0297613407  0.06617141
POSTAL_CODE         -0.65219387 -0.10128002  0.0851135238  0.01693124
ANNUAL_MILEAGE      -0.16507461 -0.04673048  0.0010660730 -0.01166121
VEHICLE_TYPE         0.18725969 -0.96788405 -0.0073036818  0.15488723
SPEEDING_VIOLATIONS -0.13321403 -0.03988093  0.0009741718  0.02648961
DUIS                -0.25464857 -0.07076945 -0.1120181060 -0.11061375
PAST_ACCIDENTS       0.21299741  0.05653190  0.0147063912  0.04930419
                             PC9         PC10         PC11        PC12
AGE                 -0.036722101  0.168855395 -0.012145227 -0.25509974
GENDER               0.017128543  0.036364544 -0.083091139 -0.37459953
RACE                 0.148924559  0.073445633 -0.008967534 -0.10701222
DRIVING_EXPERIENCE  -0.003008329  0.178442611  0.051512605  0.06327171
EDUCATION           -0.428974877 -0.086724203 -0.132170242  0.55019779
INCOME              -0.122834886  0.022107350 -0.006893772 -0.11172354
CREDIT_SCORE        -0.255397114  0.062474743 -0.040406358 -0.36282400
VEHICLE_OWNERSHIP    0.777855259  0.009679359 -0.003310496  0.13144775
VEHICLE_YEAR         0.308196174 -0.187782222  0.049191205  0.09160486
MARRIED             -0.035873267 -0.210771715  0.629612580 -0.24129189
CHILDREN             0.085752846  0.063465246 -0.722357265 -0.13417641
POSTAL_CODE          0.031769618  0.257036683  0.047383278 -0.11079212
ANNUAL_MILEAGE      -0.032504827  0.118467284 -0.059065587 -0.32264584
VEHICLE_TYPE        -0.005984024  0.012762442 -0.033235562 -0.01683313
SPEEDING_VIOLATIONS  0.030506672  0.118267332  0.067366264  0.26590893
DUIS                -0.009295105 -0.820879174 -0.162269015 -0.10792425
PAST_ACCIDENTS      -0.005667597  0.262893729  0.112758590  0.17718505
                           PC13         PC14         PC15          PC16
AGE                 -0.10366812  0.253870924  0.594532800 -0.1049456144
GENDER               0.07010715  0.070198234  0.113657648  0.1618176038
RACE                 0.04036062 -0.021022066  0.014937273 -0.0115747337
DRIVING_EXPERIENCE  -0.09820348  0.137267180  0.064178119  0.6178535343
EDUCATION           -0.29093648  0.142055256 -0.014017047  0.1628186429
INCOME               0.05597315 -0.011402454  0.158793665 -0.5568768678
CREDIT_SCORE         0.45100744 -0.336493352 -0.322476176  0.2846041888
VEHICLE_OWNERSHIP   -0.02546653 -0.021740680 -0.030734247  0.0762451610
VEHICLE_YEAR        -0.02160841 -0.009130758 -0.043008504  0.0567752830
MARRIED             -0.31830446  0.193333873 -0.292850858  0.0327436139
CHILDREN            -0.23534720  0.098785076 -0.289705639 -0.0208604763
POSTAL_CODE         -0.25848473 -0.170292499 -0.027546406 -0.0079027711
ANNUAL_MILEAGE      -0.40974915  0.284740432 -0.391589801 -0.1369918457
VEHICLE_TYPE        -0.01462770 -0.018707899 -0.005540595 -0.0009016813
SPEEDING_VIOLATIONS  0.44968567  0.422718500 -0.392729685 -0.2848971025
DUIS                -0.06855182 -0.156136407  0.020633578 -0.0489708229
PAST_ACCIDENTS      -0.28673947 -0.645454430 -0.136338603 -0.2244206365
                            PC17
AGE                 -0.515515574
GENDER               0.054864653
RACE                -0.000340434
DRIVING_EXPERIENCE   0.476768473
EDUCATION           -0.176691693
INCOME               0.607700950
CREDIT_SCORE        -0.218882139
VEHICLE_OWNERSHIP   -0.076859848
VEHICLE_YEAR        -0.054200190
MARRIED             -0.023756833
CHILDREN             0.027648644
POSTAL_CODE         -0.012120523
ANNUAL_MILEAGE      -0.049989610
VEHICLE_TYPE        -0.000421445
SPEEDING_VIOLATIONS -0.149153451
DUIS                -0.038486234
PAST_ACCIDENTS      -0.137650140</code></pre>
</div>
</div>
<p>This is hard to understand as there is simply too many numbers. We can use the <code>tidy</code> function to make this cleaner.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>rot_matrix <span class="ot">&lt;-</span> pca <span class="sc">|&gt;</span> <span class="fu">tidy</span>(<span class="at">matrix =</span> <span class="st">"rotation"</span>)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>pc1 <span class="ot">&lt;-</span> rot_matrix <span class="sc">|&gt;</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(PC <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="fu">abs</span>(value)))</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>pc1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 17 × 3
   column                 PC    value
   &lt;chr&gt;               &lt;dbl&gt;    &lt;dbl&gt;
 1 AGE                     1 -0.388  
 2 INCOME                  1 -0.383  
 3 DRIVING_EXPERIENCE      1 -0.361  
 4 CREDIT_SCORE            1 -0.297  
 5 SPEEDING_VIOLATIONS     1 -0.297  
 6 PAST_ACCIDENTS          1 -0.272  
 7 MARRIED                 1 -0.254  
 8 CHILDREN                1 -0.230  
 9 EDUCATION               1 -0.225  
10 ANNUAL_MILEAGE          1  0.214  
11 VEHICLE_OWNERSHIP       1 -0.199  
12 DUIS                    1 -0.193  
13 VEHICLE_YEAR            1 -0.167  
14 GENDER                  1 -0.0451 
15 RACE                    1 -0.0267 
16 POSTAL_CODE             1 -0.0188 
17 VEHICLE_TYPE            1  0.00586</code></pre>
</div>
</div>
<p>Prinicipal Component 1 is the direction with the most variance and the variables with the largest value are the largest contributors to this principal component direction. We see that <code>AGE</code>, <code>INCOME</code>, and <code>DRIVING EXPERIENCE</code> are all very important to preserving variance in the data. Lets visualize the first 3 principal component directions and what variables are making up each direction.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>pca <span class="sc">|&gt;</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy</span>(<span class="at">matrix =</span> <span class="st">"loadings"</span>) <span class="sc">|&gt;</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(PC <span class="sc">&lt;</span> <span class="dv">4</span>) <span class="sc">|&gt;</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span> (<span class="at">y =</span> column, <span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">y =</span> column)) <span class="sc">+</span> </span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Loadings"</span>, <span class="at">y =</span> <span class="st">"Variable"</span>) <span class="sc">+</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>PC)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Report_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Here are some observations from the above graphic: + <code>VEHICHLE_YEAR</code>, <code>PAST_ACCIDENTS</code>, <code>INCOME</code>, <code>DRIVING_EXPERIENCE</code> seem to be important features + <code>VEHICHLE_TYPE</code>, <code>RACE</code>, <code>POSTAL CODE</code> do not seem to be important variables + <code>AGE</code> matters a lot in the first direction but not so much in the other directions + <code>ANNUAL_MILEAGE</code> is a massive contributor to principal component direction 3 + <code>EDUCATION</code> and <code>INCOME</code> vary together indicating they are highly correlated.</p>
<p>Now we see how important each principal component direction is.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>pca <span class="sc">|&gt;</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy</span>(<span class="at">matrix =</span> <span class="st">"pcs"</span>) <span class="sc">|&gt;</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(PC), <span class="at">y =</span> percent)) <span class="sc">+</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Percent variance explained"</span>, <span class="at">x =</span> <span class="st">"Principal Component"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Report_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Theres a lot of principal components so it may be easier to view this data in a table.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>pca <span class="sc">|&gt;</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy</span>(<span class="at">matrix =</span> <span class="st">"pcs"</span>) <span class="sc">|&gt;</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(cumulative <span class="sc">&lt;</span> .<span class="dv">90</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 4
      PC std.dev percent cumulative
   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;      &lt;dbl&gt;
 1     1   2.12   0.264       0.264
 2     2   1.29   0.0986      0.362
 3     3   1.15   0.0785      0.441
 4     4   1.04   0.0638      0.505
 5     5   1.02   0.0612      0.566
 6     6   1.00   0.0590      0.625
 7     7   0.991  0.0578      0.683
 8     8   0.919  0.0497      0.732
 9     9   0.880  0.0456      0.778
10    10   0.864  0.0439      0.822
11    11   0.839  0.0414      0.863
12    12   0.765  0.0344      0.897</code></pre>
</div>
</div>
<p>If we wanted to retain 90% of the variance in the data, we see that we would need the first 12 principal component directions.</p>
</section>
<section id="exploratory-graphs" class="level2">
<h2 class="anchored" data-anchor-id="exploratory-graphs">Exploratory Graphs</h2>
<p>Lets look at the distribution of some of the variables to see if it is normal.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"factor_data.csv"</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> CREDIT_SCORE)) <span class="sc">+</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">20</span>, <span class="at">fill =</span> <span class="st">"khaki"</span>, <span class="at">color =</span> <span class="st">"black"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Report_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co">#df["GENDER"] &lt;- lapply(df["GENDER"], factor)</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="co">#df |&gt;</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#ggplot(mapping = aes(x = CREDIT_SCORE, fill = GENDER)) +</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_histogram(bins = 20)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We see that <code>CREDIT_SCORE</code> appears to be relatively normally distributed. Now lets see if there are any differences across <code>AGE</code>. The data is scaled, as credit scores typically range from 300 to 850.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"AGE"</span>] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(df[<span class="st">"AGE"</span>], factor)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> CREDIT_SCORE, <span class="at">fill =</span> AGE)) <span class="sc">+</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Report_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>AGE = 0 refers to the youngest and AGE = 3 refers to the oldest in the above graph. We see that older people have on average a higher credit score than the younger people, with very few people in the youngest age bracket having a credit score above 0.5.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> PAST_ACCIDENTS, <span class="at">y =</span> OUTCOME, <span class="at">color =</span> GENDER)) <span class="sc">+</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_gradient</span>(<span class="at">low =</span> <span class="st">"pink"</span>, <span class="at">high =</span> <span class="st">"dodgerblue"</span>) <span class="sc">+</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Report_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This plot contains three dimensions of data relating <code>OUTCOME</code>, <code>PAST_ACCIDENTS</code>, and <code>GENDER</code>. The pink dots correspond to women and the blue dots correspond to men. We see that there are a lot of men that have a lot of accidents. We also see that <code>PAST_ACCIDENTS</code> corresponds strongly with <code>OUTCOME</code> and that all observations that have more than 7 accidents are all did not file a claim. This may be due to the way the insurance company works with the company no longer accepting claims after a certain number of accidents.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> EDUCATION, <span class="at">y =</span> INCOME, <span class="at">color =</span> CREDIT_SCORE)) <span class="sc">+</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>() <span class="sc">+</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_gradient</span>(<span class="at">low =</span> <span class="st">"red"</span>, <span class="at">high =</span> <span class="st">"green"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Report_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We visualize <code>INCOME</code>, <code>EDUCATION</code>, and <code>CREDIT_SCORE</code> and find see that there are very few individuals that have high education but low income or low education and high income, indicating that these are positively correlated with each other. Additionally, those with high education and low income have poor credit scores, likely because they have high debt. <code>CREDIT_SCORE</code> is difficult to visualize, but it seems that there are not significant changes going from left to right (<code>EDUCATION</code> AND <code>CREDIT_SCORE</code> are weakly correlated) but that points on the top are more green than those at the bottom indicating that <code>CREDIT_SCORE</code> and <code>INCOME</code> are positively correlated.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"AGE"</span>] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(df[<span class="st">"AGE"</span>], factor)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>df <span class="sc">|&gt;</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> AGE, <span class="at">y =</span> DRIVING_EXPERIENCE)) <span class="sc">+</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Report_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>As the density of the points along the diagonal are significantly higher than any other point on the graph, it is clear that <code>DRIVING_EXPERIENCE</code> and <code>AGE</code> are highly correlated with each other. It is also interesting that half this graph does not even exist because it is impossible to be in the youngest age and have lots of driving experience.</p>
</section>
</section>
<section id="modeling" class="level1">
<h1>Modeling</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"factor_data.csv"</span>)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>factor_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"AGE"</span>, <span class="st">"GENDER"</span>, <span class="st">"RACE"</span>, <span class="st">"DRIVING_EXPERIENCE"</span>,</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"EDUCATION"</span>, <span class="st">"INCOME"</span>, <span class="st">"VEHICLE_OWNERSHIP"</span>,</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"VEHICLE_YEAR"</span>, <span class="st">"MARRIED"</span>, <span class="st">"CHILDREN"</span>, <span class="st">"POSTAL_CODE"</span>,</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"VEHICLE_TYPE"</span>, <span class="st">"SPEEDING_VIOLATIONS"</span>, <span class="st">"DUIS"</span>,</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"PAST_ACCIDENTS"</span>, <span class="st">"OUTCOME"</span>)</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>df[factor_cols] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(df[factor_cols], factor)</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df[<span class="dv">2</span><span class="sc">:</span><span class="dv">19</span>] <span class="co"># This is all the predictors + outcome</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that our data is clean and each column is the correct data type, let’s create some sub samples of our data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>ttsplit <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">initial_split</span>(<span class="at">prop =</span> <span class="fl">0.95</span>)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>ttsplit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;Training/Testing/Total&gt;
&lt;9500/500/10000&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>train <span class="ot">&lt;-</span> ttsplit <span class="sc">|&gt;</span> <span class="fu">training</span>()</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>test <span class="ot">&lt;-</span> ttsplit <span class="sc">|&gt;</span> <span class="fu">testing</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(train<span class="sc">$</span>OUTCOME)[<span class="dv">1</span>] <span class="sc">/</span> <span class="fu">nrow</span>(train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        0 
0.6866316 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(test<span class="sc">$</span>OUTCOME)[<span class="dv">1</span>] <span class="sc">/</span> <span class="fu">nrow</span>(test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    0 
0.688 </code></pre>
</div>
</div>
<p>The proportions within each split is roughly equal in terms of the <code>OUTCOME</code> variable.</p>
<section id="custom-function" class="level2">
<h2 class="anchored" data-anchor-id="custom-function">Custom function</h2>
<p>When analyzing the performance of each model, we’re going to want to use a confusion matrix multiple times. This way, our code will be more readable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>conf_mat <span class="ot">&lt;-</span> <span class="cf">function</span>(y_truth, y_hat){</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This function takes in the ground truth and an estimate and </span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># returns a confusion matrix</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  tab <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="at">Actual_Values =</span> y_truth, </span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">Predicted_Values =</span> y_hat)</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>  mat <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(tab)</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>  mat</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="model-1" class="level2">
<h2 class="anchored" data-anchor-id="model-1">Model 1</h2>
<p>First we try out a logstic regression model</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>recipe_1 <span class="ot">&lt;-</span> <span class="fu">recipe</span>(OUTCOME <span class="sc">~</span> .,</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> train)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>recipe_1 <span class="ot">&lt;-</span> recipe_1 <span class="sc">|&gt;</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">|&gt;</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>() </span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>parsnip_1 <span class="ot">&lt;-</span> <span class="fu">logistic_reg</span>() <span class="sc">|&gt;</span> </span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"glm"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>) </span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>workflow_1 <span class="ot">&lt;-</span> <span class="fu">workflow</span>()</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>workflow_1 <span class="ot">&lt;-</span> workflow_1 <span class="sc">|&gt;</span></span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(parsnip_1) <span class="sc">|&gt;</span></span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(recipe_1)</span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>fit_1 <span class="ot">&lt;-</span> workflow_1 <span class="sc">|&gt;</span></span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred</code></pre>
</div>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>preds_1 <span class="ot">&lt;-</span> fit_1 <span class="sc">|&gt;</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(test, <span class="at">type =</span> <span class="st">"class"</span>) <span class="sc">|&gt;</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(.pred_class)</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>preds_1_prob <span class="ot">&lt;-</span> fit_1 <span class="sc">|&gt;</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(test, <span class="at">type =</span> <span class="st">"prob"</span>)</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a><span class="fu">conf_mat</span>(<span class="at">y_truth =</span> test<span class="sc">$</span>OUTCOME,</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_hat =</span> preds_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             Predicted_Values
Actual_Values   0   1
            0 312  32
            1  48 108</code></pre>
</div>
</div>
</section>
<section id="model-2" class="level2">
<h2 class="anchored" data-anchor-id="model-2">Model 2</h2>
<p>Next we try a random forest model. We tried multiple models and picked these hyperparameters as a result.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>parsnip_2 <span class="ot">&lt;-</span> <span class="fu">rand_forest</span>(<span class="at">mtry =</span> <span class="dv">15</span>, <span class="at">trees =</span> <span class="dv">30</span>) <span class="sc">|&gt;</span> </span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"ranger"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>workflow_2 <span class="ot">&lt;-</span> <span class="fu">workflow</span>()</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>workflow_2 <span class="ot">&lt;-</span> workflow_2 <span class="sc">|&gt;</span></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(parsnip_2) <span class="sc">|&gt;</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(recipe_1)</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>fit_2 <span class="ot">&lt;-</span> workflow_2 <span class="sc">|&gt;</span></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(train)</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>preds_2 <span class="ot">&lt;-</span> fit_2 <span class="sc">|&gt;</span></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(test, <span class="at">type =</span> <span class="st">"class"</span>) <span class="sc">|&gt;</span></span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(.pred_class)</span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a>preds_2_prob <span class="ot">&lt;-</span> fit_2 <span class="sc">|&gt;</span></span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(test, <span class="at">type =</span> <span class="st">"prob"</span>)</span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a><span class="fu">conf_mat</span>(<span class="at">y_truth =</span> test<span class="sc">$</span>OUTCOME,</span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_hat =</span> preds_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             Predicted_Values
Actual_Values   0   1
            0 311  33
            1  45 111</code></pre>
</div>
</div>
</section>
<section id="model-3" class="level2">
<h2 class="anchored" data-anchor-id="model-3">Model 3</h2>
<p>Next we try a support vector machine.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>parsnip_3 <span class="ot">&lt;-</span> <span class="fu">svm_rbf</span>() <span class="sc">|&gt;</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"kernlab"</span>) <span class="sc">|&gt;</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>workflow_3 <span class="ot">&lt;-</span> <span class="fu">workflow</span>()</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>workflow_3 <span class="ot">&lt;-</span> workflow_3 <span class="sc">|&gt;</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(parsnip_3) <span class="sc">|&gt;</span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(recipe_1)</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>fit_3 <span class="ot">&lt;-</span> workflow_3 <span class="sc">|&gt;</span></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(train)</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>preds_3 <span class="ot">&lt;-</span> fit_3 <span class="sc">|&gt;</span></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(test, <span class="at">type =</span> <span class="st">"class"</span>) <span class="sc">|&gt;</span></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(.pred_class)</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>preds_3_prob <span class="ot">&lt;-</span> fit_3 <span class="sc">|&gt;</span></span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(test, <span class="at">type =</span> <span class="st">"prob"</span>)</span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a><span class="fu">conf_mat</span>(<span class="at">y_truth =</span> test<span class="sc">$</span>OUTCOME,</span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_hat =</span> preds_3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             Predicted_Values
Actual_Values   0   1
            0 314  30
            1  43 113</code></pre>
</div>
</div>
</section>
<section id="model-4" class="level2">
<h2 class="anchored" data-anchor-id="model-4">Model 4</h2>
<p>Next we try a boosted forest. We tried multiple hyperparameters and got strong performance with these ones.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>parsnip_4 <span class="ot">&lt;-</span> <span class="fu">boost_tree</span>(<span class="at">trees =</span> <span class="dv">10</span>, <span class="at">learn_rate =</span> <span class="fl">0.4</span>,</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">tree_depth =</span> <span class="dv">6</span>) <span class="sc">|&gt;</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>) <span class="sc">|&gt;</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>workflow_4 <span class="ot">&lt;-</span> <span class="fu">workflow</span>()</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>workflow_4 <span class="ot">&lt;-</span> workflow_4 <span class="sc">|&gt;</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(parsnip_4) <span class="sc">|&gt;</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(recipe_1)</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>fit_4 <span class="ot">&lt;-</span> workflow_4 <span class="sc">|&gt;</span></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(train)</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>preds_4 <span class="ot">&lt;-</span> fit_4 <span class="sc">|&gt;</span></span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(test, <span class="at">type =</span> <span class="st">"class"</span>) <span class="sc">|&gt;</span></span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(.pred_class)</span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>preds_4_prob <span class="ot">&lt;-</span> fit_4 <span class="sc">|&gt;</span></span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(test, <span class="at">type =</span> <span class="st">"prob"</span>)</span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a><span class="fu">conf_mat</span>(<span class="at">y_truth =</span> test<span class="sc">$</span>OUTCOME,</span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_hat =</span> preds_4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             Predicted_Values
Actual_Values   0   1
            0 308  36
            1  38 118</code></pre>
</div>
</div>
</section>
<section id="model-5" class="level2">
<h2 class="anchored" data-anchor-id="model-5">Model 5</h2>
<p>Our last model is a k nearest neighbors and we chose 17 after trying various other values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>parsnip_5 <span class="ot">&lt;-</span> <span class="fu">nearest_neighbor</span>(<span class="at">neighbors =</span> <span class="dv">17</span>) <span class="sc">|&gt;</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"kknn"</span>) <span class="sc">|&gt;</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>workflow_5 <span class="ot">&lt;-</span> <span class="fu">workflow</span>()</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>workflow_5 <span class="ot">&lt;-</span> workflow_5 <span class="sc">|&gt;</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(parsnip_5) <span class="sc">|&gt;</span></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(recipe_1)</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>fit_5 <span class="ot">&lt;-</span> workflow_5 <span class="sc">|&gt;</span></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(train)</span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>preds_5 <span class="ot">&lt;-</span> fit_5 <span class="sc">|&gt;</span></span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(test, <span class="at">type =</span> <span class="st">"class"</span>) <span class="sc">|&gt;</span></span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(.pred_class)</span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>preds_5_prob <span class="ot">&lt;-</span> fit_5 <span class="sc">|&gt;</span></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(test, <span class="at">type =</span> <span class="st">"prob"</span>)</span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a><span class="fu">conf_mat</span>(<span class="at">y_truth =</span> test<span class="sc">$</span>OUTCOME,</span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">y_hat =</span> preds_5)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             Predicted_Values
Actual_Values   0   1
            0 305  39
            1  50 106</code></pre>
</div>
</div>
<p>We now have created five models and assessed how each of them did on the test data set. Let’s store their values into a tibble so that we can easily visualize and analyze our results later.</p>
</section>
<section id="model-assessment-using-list-columns" class="level2">
<h2 class="anchored" data-anchor-id="model-assessment-using-list-columns">Model Assessment using list columns</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>workflow_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"glm"</span>, </span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"rf"</span>,</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"svm"</span>,</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"xgboost"</span>,</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"knn"</span>)</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>preds <span class="ot">&lt;-</span> <span class="fu">list</span>(preds_1,</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>              preds_2,</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>              preds_3,</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>              preds_4,</span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>              preds_5)</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>preds_prob <span class="ot">&lt;-</span> <span class="fu">list</span>(preds_1_prob,</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>                   preds_2_prob,</span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>                   preds_3_prob,</span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>                   preds_4_prob,</span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>                   preds_5_prob)</span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>truth <span class="ot">&lt;-</span> <span class="fu">list</span>(test<span class="sc">$</span>OUTCOME,</span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a>              test<span class="sc">$</span>OUTCOME,</span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>              test<span class="sc">$</span>OUTCOME,</span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>              test<span class="sc">$</span>OUTCOME,</span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a>              test<span class="sc">$</span>OUTCOME)</span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a>workflows_tbl <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">work_names =</span> workflow_names,</span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true" tabindex="-1"></a>                        <span class="at">preds =</span> preds,</span>
<span id="cb79-27"><a href="#cb79-27" aria-hidden="true" tabindex="-1"></a>                        <span class="at">preds_prob =</span> preds_prob,</span>
<span id="cb79-28"><a href="#cb79-28" aria-hidden="true" tabindex="-1"></a>                        <span class="at">truth =</span> truth)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Above we had already predicted how well each model did on test data. Now we evaluate how we did by comparing the ROC curves, AUC scores, and accuracy scores to select the best model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>workflows_tbl <span class="sc">|&gt;</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(<span class="at">cols =</span> <span class="fu">c</span>(preds, preds_prob, truth)) <span class="sc">|&gt;</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(work_names) <span class="sc">|&gt;</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_curve</span>(<span class="at">truth =</span> truth,</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>            .pred_1,</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">event_level =</span> <span class="st">"second"</span>) <span class="sc">|&gt;</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">-</span> specificity, </span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>             <span class="at">y =</span> sensitivity, </span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> work_names)) <span class="sc">+</span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_path</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Report_files/figure-html/unnamed-chunk-36-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>workflows_tbl <span class="sc">|&gt;</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(<span class="at">cols =</span> <span class="fu">c</span>(preds, preds_prob, truth)) <span class="sc">|&gt;</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(work_names) <span class="sc">|&gt;</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">roc_auc</span>(<span class="at">truth =</span> truth,</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>            .pred_1,</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">event_level =</span> <span class="st">"second"</span>) <span class="sc">|&gt;</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(.estimate)) <span class="sc">|&gt;</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> .estimate,</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">y =</span> <span class="fu">reorder</span>(work_names, .estimate),</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>             <span class="at">fill =</span> work_names)) <span class="sc">+</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">round</span>(.estimate,<span class="dv">3</span>)), <span class="at">hjust =</span> <span class="fl">1.1</span>) <span class="sc">+</span> </span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Model"</span>,</span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"AUC Score"</span>,</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Model"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Report_files/figure-html/unnamed-chunk-37-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>workflows_tbl <span class="sc">|&gt;</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(work_names) <span class="sc">|&gt;</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(<span class="at">cols =</span> <span class="fu">c</span>(preds, truth)) <span class="sc">|&gt;</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">acc =</span> <span class="fu">accuracy_vec</span>(truth, preds)) <span class="sc">|&gt;</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">cols =</span> <span class="fu">c</span>(preds,truth)) <span class="sc">|&gt;</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">c</span>(work_names, acc)) <span class="sc">|&gt;</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(acc)) <span class="sc">|&gt;</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> acc,</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>             <span class="at">y =</span> <span class="fu">reorder</span>(work_names, acc),</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>             <span class="at">fill =</span> work_names)) <span class="sc">+</span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">round</span>(acc,<span class="dv">3</span>)), <span class="at">hjust =</span> <span class="fl">1.1</span>) <span class="sc">+</span> </span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Model"</span>,</span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Accuracy"</span>,</span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Model"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Report_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="model-selection" class="level2">
<h2 class="anchored" data-anchor-id="model-selection">Model Selection</h2>
<p>Out of the 5 models chosen, we examined two criteria: AUC score and accuracy. We measured each of these criterion on a testing/holdout subset of the original dataset. Each model was trained on a separate training subset. In last place for both measures was our knn model. Our XGboost model performed second best in each criterion, while the model with the highest AUC was the GLM, and the model with the highest accuracy was the SVM. Because the difference in each measure between first and second place is so marginal, we conclude that XGboost performed best.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vip)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'vip'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:utils':

    vi</code></pre>
</div>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>fit_4 <span class="sc">|&gt;</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">|&gt;</span> </span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">vip</span>(<span class="at">num_features =</span> <span class="dv">15</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Report_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>According to our preferred model, <code>VEHICLE_OWNERSHIP</code> and <code>DRIVING_EXPERIENCE</code> were the most important factors influencing <code>OUTCOME</code>.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>The six add ons that we chose were</p>
<ul>
<li><p>PCA</p></li>
<li><p>Impute missing values</p></li>
<li><p>Clean data with regular expression</p></li>
<li><p>Make a github <a href="https://github.com/joshmoak/STAT_5125_Project">repo</a></p></li>
<li><p>Custom function</p></li>
<li><p>Using list columns in a data frame</p></li>
</ul>
<p>To summarize, our goal was to predict whether or not a given customer would file an auto insurance claim. The insurance company has an interest in maximizing profits, so knowing which customers are more likely to file claims is quite valuable.</p>
<p>After cleaning the data, we were left with 18 predictors, most of which were categorical variables. Categorical variables can be difficult to visualize, so we tried our best using the jitter plots and looking at up to three dimensions of data before proceeding with modelling. On our chosen criteria, our XGBoost model performed the best with an accuracy of 85% on a holdout dataset. We then identified the features which were most important in the model’s decision making process: <code>VEHICLE_OWNERSHIP</code> and <code>DRIVING_EXPERIENCE</code>. This seems pretty reasonable based on what we know about car insurance claims. If somebody does not own the car they are driving (They may rent it or lease it) they may not be likely to file a claim. They may need to fill out more paperwork with whatever company they rented the car from, but not necessarily file a claim. Additionally <code>DRIVING_EXPERIENCE</code> was an important feature, possibly because newer drivers may not want to file a claim and have their insurance premiums dramatically increase. If they think that they could afford to pay the damage out of pocket, they could choose to do so, and that drivers with much more experience may be more likely to file a claim.</p>
<p>To improve the quality of our predictions, we are interested in more detailed data. For example, the <code>AGE</code> column had 4 categories. Effectively, it lumped several age groups together. A more detailed dataset might reveal a difference between a 16 year old driver and a 24 year old driver, whereas our dataset was blind to such distinction. A history of each driver would also be a benefit of a more detailed dataset. Almost all the data being categorical dramatically reduced the effectiveness of it. When we started the project we didn’t realize the data was structured like this until we started to dive into it and clean it. For instance the variable VECHICLE_YEAR was originally a binary variable with two options “before 2015” or “after 2015”. If instead we had the precise year, this could have been a much more powerful variable that is predictive of OUTCOME.</p>
</section>
<section id="next-steps" class="level2">
<h2 class="anchored" data-anchor-id="next-steps">Next Steps</h2>
<p>In the future we could try and find data relating to median income and education levels based on postal code and join it with future data sets. The postal code column by itself is not very helpful, but if we had been able to learn more about each type postal code and if there are any major highways or windy roads that could potentially lead to increased chance of an accident, perhaps interesting insights could be obtained. While we may need some domain knowledge of the postal codes available in the data in order to derive meaningful insights, joining the data set with another based on postal codes is still an interesting possibility to explore in the future.</p>
<p>While we did some informal hyperparameter tuning by testing a handful of parameters and then choosing the best one, it may be possible to get better results with even more tuning via grid search. However this can be computationally expensive and we were able to achieve satisfactory results using the approaches above.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>